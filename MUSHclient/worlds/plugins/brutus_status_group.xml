<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Ã¨tvrtek, duben 16, 2015, 11:18 odp. -->
<!-- MuClient version 4.73 -->

<!-- Plugin "brutus_group_window" generated by Plugin Wizard -->

<muclient>
<plugin
   name="brutus_status_group"
   author="huan"
   id="af7994242f3b0a26e4f54958"
   language="Lua"
   purpose="display group info in a window"
   save_state="y"
   date_written="2015-04-16 23:17:32"
   requires="4.73"
   version="1.0"
   >

</plugin>

<triggers>
  <trigger
   enabled="y"
   keep_evaluating="y"
   match="*Your group * consists of:*"
   script="group_info"
   sequence="0"
   omit_from_output="y"
   />
  <!-- hide group auto plist from normal output, it's quite a spam -->
  <trigger
   enabled="y"
   keep_evaluating="y"
   match="^\s*\d+\. SpNCP \[.*"
   omit_from_output="y"
   regexp="y"
   sequence="1"
   />
  <trigger
   enabled="y"
   keep_evaluating="y"
   match="^\s*\d+\. jgbr \[.*"
   regexp="y"
   omit_from_output="y"
   sequence="1"
   />
  <trigger
   enabled="y"
   keep_evaluating="y"
   match="^(?:You leave the group\.|Your group has been disbanded\.|You leave the group\.)$"
   regexp="y"
   sequence="1"
   script="cleanup"
   />
</triggers>

<include name="constants.lua"/>
<script><![CDATA[

require "wait"
require "tprint"
require "serialize"

local GR_LIST_PRIORITY = 1

local PLIST_RX = rex.new("^\\s*\\d+\\. SpNCP \\[.*")
local DLIST_RX = rex.new("^\\s*\\d+\\. jgbr \\[.*")

function cleanup()
  CallPlugin('b3a9c0bdeef9394ff401358a', 'clear_item', 'grouplist');
end

function group_info(name, wildcard, output)
   local grouplist = {}
   wait.make (function ()  -- coroutine starts here

      while true do
         local line, wildcards, styles = wait.match ("*", nil, trigger_flag.KeepEvaluating)

         -- 1. SpNCP [ 100%H  100%M  100%V] [ R4 Pr Pix] charname (Head)
         -- 1. jgbr [ 100%H  100%M  100%V] [ R4 Pr Pix] charname (Head)

         local dummy, dummy2, match = PLIST_RX:match(line)
         if match ~= nil then
            table.insert (grouplist, styles)
         end
         local dummy, dummy2, match = DLIST_RX:match(line)
         if match ~= nil then
            table.insert (grouplist, styles)
         end

         -- no match -> normal mud output resumes
         break
      end

      CallPlugin('b3a9c0bdeef9394ff401358a', 'update_item', 'grouplist', serialize.save_simple(
        {
           ["priority"] = GR_LIST_PRIORITY,
           ["lines"] = grouplist
        }
      ));
      return;
 end
 ); -- coroutine ends here
end

function OnPluginClose()
  cleanup()
end

function OnPluginDisable ()
  cleanup()
end --  OnPluginDisable

]]></script>
</muclient>
<!-- vim: sw=3 et ts=3 syntax=lua -->
